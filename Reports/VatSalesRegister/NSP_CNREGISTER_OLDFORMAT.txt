CREATE OR ALTER PROCEDURE [dbo].[NSP_CNREGISTER_OLDFORMAT]

--DECLARE
@DATE1 DATETIME,
@DATE2 DATETIME,
@TMR VARCHAR(25) = '%',
@DIVISION AS VARCHAR(25) = '%'

AS

--SET @DATE1 = '01-15-16'; SET @DATE2 = '01-15-17';SET @TMR = '%'; SET @DIV = '%'
set nocount on
IF OBJECT_ID('TEMPDB..#REPORT') is not null drop table #REPORT

SELECT TRNDATE, BSDATE, VCHRNO, REFBILL,
COALESCE(NULLIF(TM.BILLTO,''), CP.CUSTNAME, M.FNAME, A.ACNAME,'') PARTICULARS,
COALESCE(NULLIF(TM.BILLTOTEL,''), CP.PANNO, M.PANNO, A.VATNO,'') VATNO,
(TAXABLE+NONTAXABLE+DCAMNT+VATAMNT) NET,NONTAXABLE AS NONTAXABLE,NULL ZERORATED,TAXABLE,VATAMNT,DCAMNT, REMARKS,
ISNULL(VNUM,VCHRNO) VNO,DIVISION INTO #REPORT 
FROM SALES_TRNMAIN TM 
LEFT JOIN CustomerProfile CP ON TM.RECEIVEBY = CP.CUSTID
LEFT JOIN MEMBERSHIP M ON M.MEMID = TM.MEMBERNO
LEFT JOIN RMD_ACLIST A ON TM.PARAC = A.ACID 
WHERE VoucherType in ('CN','SR')
AND (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2) AND ISNULL(TERMINAL,'') LIKE @TMR 		
AND DIVISION LIKE @DIVISION 

SELECT TRNDATE,BSDATE,VCHRNO,REFBILL, PARTICULARS,VATNO,
CONVERT(NUMERIC(18,2),NET)NET,
CONVERT(NUMERIC(18,2),NONTAXABLE) NONTAXABLE,
CONVERT(NUMERIC(18,2),ZERORATED) ZERORATED,
CONVERT(NUMERIC(18,2),TAXABLE) TAXABLE,
CONVERT(NUMERIC(18,2),VATAMNT) VATAMNT,
CONVERT(NUMERIC(18,2),DCAMNT) DCAMNT,REMARKS,VCHRNO,DIVISION, [TYPE] FROM
(
SELECT TRNDATE,BSDATE,VCHRNO,REFBILL,PARTICULARS,VATNO,NET,NONTAXABLE,ZERORATED,TAXABLE,VATAMNT,DCAMNT, REMARKS,VNO,DIVISION,'A' FLG, 'A' [TYPE] FROM #REPORT
UNION ALL
SELECT NULL,NULL,NULL,NULL,'TOTAL >>' PARTICULARS,NULL VATNO,SUM(NET),SUM(NONTAXABLE),SUM(ZERORATED),SUM(TAXABLE),SUM(VATAMNT), SUM(DCAMNT), NULL REMARKS,NULL VNO,NULL DIVISION,'B' FLG, 'G' [TYPE] FROM #REPORT
)A ORDER BY FLG,TRNDATE, left(VNO,2),CAST(SUBSTRING(VNO,3,LEN(VNO)) AS NUMERIC)