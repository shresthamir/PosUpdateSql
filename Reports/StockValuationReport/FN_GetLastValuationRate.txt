CREATE OR ALTER FUNCTION [dbo].[FN_GetLastValuationRate]
(
	@VAL_DATE DATE,
	@JSON VARCHAR(MAX),
	@DIVISION VARCHAR(3),
	@PHISCALID VARCHAR(5),
	@IgnoreTRRate VARCHAR(2)
)
RETURNS TABLE
AS
RETURN
(
	SELECT B.DIVISION, B.VCHRNO, A.MCODE,COALESCE(NULLIF(B.CRATE,0),NULLIF(B.PRATE,0),NULLIF(B.RATE,0),NULLIF(A.CRATE,0),NULLIF(A.PRATE_A,0)) VAL_RATE	
	FROM MENUITEM A WITH (NOLOCK)
	JOIN OPENJSON(@JSON) WITH (MCODE VARCHAR(25)) Y ON A.MCODE = Y.MCODE  -- JOINED AGAIN TO FILTER OUT UNNECESSARY MCODE
	LEFT JOIN
	(
		SELECT ROW_NUMBER() OVER(PARTITION BY B.DIVISION, B.MCODE ORDER BY IIF(A.VOUCHERTYPE = 'OP', '1 JAN 1990', A.TRNDATE + A.TRNTIME) DESC) SN,
		B.DIVISION, A.VCHRNO, B.MCODE, B.CRATE , B.PRATE , B.RATE
		FROM RMD_TRNPROD B WITH (NOLOCK)
		JOIN RMD_TRNMAIN A WITH (NOLOCK) ON A.VCHRNO = B.VCHRNO
		JOIN OPENJSON(@JSON) WITH (MCODE VARCHAR(25)) Y ON B.MCODE = Y.MCODE
		WHERE COALESCE(NULLIF(B.CRATE,0),NULLIF(B.PRATE,0), NULLIF(B.RATE,0),0) <> 0			-- TO RETRIEVE LATEST NON ZERO VALUE
		AND A.TRNDATE <= @VAL_DATE AND A.PhiscalID = @PHISCALID AND A.DIVISION LIKE @DIVISION AND A.VoucherType IN ('PI','OP','PD','RP','DA','DM','SA','TR') 
	) B  	ON A.MCODE = B.MCODE
	WHERE B.SN = 1
);