CREATE OR ALTER PROCEDURE [dbo].[NSP_SALESREPORT_ITEMWISE_DETAIL]
--DECLARE 
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@DIV VARCHAR(3) = '%',
	@MC VARCHAR(25) = '%',
	@BC VARCHAR(MAX)= '%',	
	@BARCODEWISEREPORT TINYINT = 0,
	@BARCODEDETAIL TINYINT =0,
	@DIVISIONWISEREPORT TINYINT = 0,
	@WISE VARCHAR(25) = 'BILLWISE',
	@SHOWINTERCOMPANYONLY TINYINT = 0,
	@PTYPE INT = 100,
	@FLAG TINYINT = 0 ---0 filter by TRNDATE |1 filter by DAYSTARTDATE
AS
--select @date1='2023-07-17',@date2='2023-09-21'
/*
set  @DATE1='2021-10-16 00:00:00' ; set @DATE2='2021-10-16 00:00:00' ; set @DIV=N'%' ; set @MC=N'%' ; set @BC=N'%' ; set @PTYPE=N'100' ;  set @WISE=N'BILLWISE' ;
SET @FLAG = 1
*/
set nocount on

DECLARE @SHOWBARCODEDETAIL TINYINT=1
DECLARE @BCDETAIL_QUERY VARCHAR(500)
DECLARE  @BARCODECOMPULOSRYMODE TINYINT = 0

SELECT @BCDETAIL_QUERY = 'SELECT BARCODE,COLOR,SIZE,MCODE FROM BARCODE_DETAIL',@SHOWBARCODEDETAIL = ISNULL(EnableBarcodeDetails,0),@BARCODECOMPULOSRYMODE = ENABLEBARCODECOMPULSORY FROM SETTING


	IF OBJECT_ID('TEMPDB..#REPDATA') is not null drop table #REPDATA
	IF OBJECT_ID('TEMPDB..#MAIN') is not null drop table #MAIN


	SELECT A.VCHRNO,B.AMOUNT,B.DISCOUNT,B.SERVICETAX ,B.TAXABLE,B.NONTAXABLE ,B.ITEMDESC,B.ALTQTY_IN,B.REALQTY_IN,B.REALRATE,B.ALTQTY,B.VAT,B.SALESMANID,A.DIVISION,A.BILLTOMOB,A.TRNMODE,A.BILLTO,B.BC,B.ALTUNIT,B.ALTRATE,B.REALQTY,B.SNO,A.MEMBERNO,A.CHALANNO,A.REFBILL,A.TRNDATE,A.REFORDBILL ,A.STAMP,A.TRNUSER,A.TRNTIME,A.TRNAC,A.TERMINAL,A.[SHIFT],X.MENUCODE,X.BASEUNIT,X.MCODE, X.PTYPE ,D.DAYDATE,Y.NAME INTO #MAIN FROM RMD_SALESPROD B INNER JOIN RMD_TRNMAIN A ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND ISNULL(A.PhiscalID,'') = ISNULL(B.PHISCALID,'')
	INNER JOIN MENUITEM X ON B.MCODE = X.MCODE LEFT JOIN DIVISION Y ON B.DIVISION = Y.INITIAL
	LEFT JOIN vwSessionDay D ON A.[SHIFT] = D.SESSIONID AND A.DIVISION = D.DIVISION AND A.PhiscalID = D.PHISCALID
	WHERE ((@SHOWINTERCOMPANYONLY=0 AND LEFT(A.VCHRNO,2) IN ('SI','TI','CN','RE')) OR (@SHOWINTERCOMPANYONLY=1 AND LEFT(A.VCHRNO,2) IN ('IC','IR')))
	AND	IIF(@FLAG=1, D.DAYDATE,	A.TRNDATE) BETWEEN @DATE1 AND @DATE2 AND A.DIVISION LIKE @DIV AND B.MCODE LIKE @MC AND ((@BARCODEWISEREPORT = 1 AND ISNULL(B.BC,'') LIKE @BC) OR (@BARCODEWISEREPORT = 0 AND ISNULL(B.BC,'') LIKE '%')) 
	AND (@PTYPE = 100 OR X.PTYPE = @PTYPE)


	SELECT ISNULL(B.BILLTOMOB, B.MEMBERNO) MOBILENO, S.NAME SALESMAN, B.MENUCODE ITEMCODE, B.ITEMDESC, B.MCODE,B.VCHRNO,B.CHALANNO,B.REFORDBILL,B.REFBILL,IIF(@FLAG=1, B.DAYDATE, B.TRNDATE) TRNDATE, DM.MITI BSDATE,B.DIVISION,
	CASE WHEN TRNMODE = 'CREDIT' THEN Z.ACNAME ELSE CASE WHEN ISNULL(BILLTO,'') <> '' THEN BILLTO ELSE Z.ACNAME END END BILLTO,
	B.BC BARCODE, B.ALTUNIT BILLUNIT,CASE WHEN LEFT(B.VCHRNO,2) IN ('SI','TI','IC') THEN AltQty ELSE ALTQTY_IN END BILLQTY,B.ALTRATE BILLRATE, 
	B.BASEUNIT BASEUNIT, CASE WHEN LEFT(B.VCHRNO,2) IN ('SI','TI','IC') THEN REALQTY ELSE REALQTY_IN END BASEQTY,REALRATE BASERATE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.AMOUNT*-1 ELSE B.AMOUNT END AMOUNT,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.DISCOUNT*-1 ELSE B.DISCOUNT END DISCOUNT,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.SERVICETAX *-1 ELSE B.SERVICETAX END SCHARGE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN (B.TAXABLE+B.NONTAXABLE) *-1 ELSE (B.TAXABLE+B.NONTAXABLE) END NETSALE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.TAXABLE*-1 ELSE B.TAXABLE END TAXABLE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.NONTAXABLE*-1 ELSE B.NONTAXABLE END NONTAXABLE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.VAT*-1 ELSE B.VAT END VAT,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN (B.TAXABLE+B.NONTAXABLE+B.VAT)*-1 ELSE (B.TAXABLE+B.NONTAXABLE+B.VAT) END NETAMNT,
	CASE WHEN @DIVISIONWISEREPORT = 1 THEN B.NAME ELSE '' END DIVISION_NAME,B.STAMP,B.TRNUSER,B.TRNTIME, TPS.StartTime, TPS.EndTime, T.[NAME] Terminal
	INTO #REPDATA
	FROM #MAIN B  
	LEFT JOIN RMD_TRNPROD_STATUS TPS ON B.VCHRNO = TPS.VCHRNO AND B.MCODE = TPS.MCODE AND B.SNO = TPS.SNO
	LEFT JOIN RMD_ACLIST Z ON B.TRNAC = Z.ACID 
	LEFT JOIN SALESMAN S ON S.SALESMANID = B.SALESMANID
	LEFT JOIN SALESTERMINAL T ON B.TERMINAL = T.INITIAL
	LEFT JOIN DATEMITI DM ON IIF(@FLAG=1, B.DAYDATE,	B.TRNDATE) = DM.AD
	


	BEGIN
		IF @WISE = 'BILLWISE'
			BEGIN
			IF @BARCODEDETAIL = 0
				SELECT TRNDATE,BSDATE,VCHRNO,REFBILL REFNO, ITEMCODE, ITEMDESC DESCA,BILLTO,BARCODE,BILLUNIT,BILLQTY,BILLRATE,BASEUNIT,BASEQTY,BASERATE,AMOUNT,DISCOUNT,SCHARGE,NETSALE,TAXABLE,NONTAXABLE,VAT,NETAMNT,TRNUSER,TRNTIME,B.NAME DIVISION, SALESMAN, MOBILENO, StartTime, EndTime, TERMINAL
				FROM #REPDATA A LEFT JOIN DIVISION B ON A.DIVISION = B.INITIAL ORDER BY TRNDATE,A.STAMP

			ELSE IF @BARCODEDETAIL = 1
				BEGIN
					DECLARE @SQL VARCHAR(MAX)
					SET @SQL = N'
					SELECT A.TRNDATE,A.BSDATE,A.VCHRNO,A.REFBILL REFNO,A.ITEMDESC DESCA,A.BILLTO,A.BILLUNIT,A.BILLQTY,A.BILLRATE,A.BASEUNIT,A.BASEQTY,A.BASERATE,A.AMOUNT,A.DISCOUNT,A.SCHARGE,A.NETSALE,A.TAXABLE,A.NONTAXABLE,A.VAT,A.NETAMNT,
					B.*,A.TRNUSER,A.TRNTIME,A.DIVISION,A.SALESMAN, A.MOBILENO FROM #REPDATA A LEFT JOIN (' + @BCDETAIL_QUERY + ') B ON A.MCODE = B.MCODE AND A.BARCODE = B.BARCODE
					ORDER BY A.TRNDATE,A.STAMP'					
					--print @sql
					EXEC(@SQL)
				END
			END
		ELSE IF @WISE = 'DAYWISE'
			IF @BARCODEDETAIL = 0
				SELECT TRNDATE,BSDATE,X.MENUCODE,X.DESCA,CASE WHEN @BARCODEWISEREPORT = 1 THEN A.BARCODE ELSE '' END BARCODE,X.BASEUNIT UNIT,SUM(BASEQTY) BASEQTY,SUM(AMOUNT) AMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(SCHARGE) SCHARGE,
				SUM(NETSALE) NETSALE,SUM(TAXABLE)TAXABLE,SUM(NONTAXABLE) NONTAXABLE, SUM(A.VAT) VAT,SUM(NETAMNT)NETAMNT,DIVISION_NAME, A.SALESMAN
				FROM #REPDATA A INNER JOIN MENUITEM X ON A.MCODE = X.MCODE GROUP BY TRNDATE,DIVISION_NAME,BSDATE,X.MENUCODE,X.DESCA,X.BASEUNIT,(CASE WHEN @BARCODEWISEREPORT = 1 THEN A.BARCODE ELSE '' END), SALESMAN ORDER BY TRNDATE,X.DESCA
			ELSE
				BEGIN
					SELECT TRNDATE,BSDATE,X.MENUCODE,X.DESCA,A.BARCODE,X.BASEUNIT UNIT,SUM(BASEQTY) BASEQTY,SUM(AMOUNT) AMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(SCHARGE) SCHARGE,
					SUM(NETSALE) NETSALE,SUM(TAXABLE)TAXABLE,SUM(NONTAXABLE) NONTAXABLE, SUM(A.VAT) VAT,SUM(NETAMNT)NETAMNT,DIVISION_NAME,X.MCODE
					INTO #REPDATA_1 FROM #REPDATA A INNER JOIN MENUITEM X ON A.MCODE = X.MCODE GROUP BY TRNDATE,BSDATE,X.MENUCODE,X.DESCA,X.BASEUNIT,A.BARCODE,DIVISION_NAME,X.MCODE

					DECLARE @SQL1 VARCHAR(MAX)
					SET @SQL1 = N'
					SELECT A.TRNDATE,A.BSDATE,A.MENUCODE,A.DESCA,A.UNIT,A.BASEQTY,A.AMOUNT,A.DISCOUNT,A.SCHARGE,A.NETSALE,A.TAXABLE,A.NONTAXABLE,A.VAT,A.NETAMNT,
					B.*,A.DIVISION_NAME FROM #REPDATA_1 A LEFT JOIN (' + @BCDETAIL_QUERY + ') B ON A.MCODE = B.MCODE AND A.BARCODE = B.BARCODE
					ORDER BY A.TRNDATE'					
					--Print @sql
					EXEC(@SQL1)
				END
	END

IF OBJECT_ID('TEMPDB..#REPDATA') is not null drop table #REPDATA
IF OBJECT_ID('TEMPDB..#REPDATA_1') is not null drop table #REPDATA_1

set nocount off